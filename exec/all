#!/bin/sh

set -e

ARCH=""
DISK_SIZE=64
RAM_SIZE=512
CPU_COUNT=1
VERBOSE=0
CLEAN=false
BUILD_ONLY=false
RELEASE=false

usage() {
    cat << EOF
UNIX V11 All-in-One Script

Usage: $0 <arch|-h> [options]

Architectures:
    AArch64  (alias: Arm64, Armv8, Armv8a, Armv8-A)
    AMD64    (alias: x86-64, x64)
    -h       Show this help

Options:
    -c         Clean before building
    -r         Release build
    -v         Verbose output
    -V         Verbose output including compiler warnings
    -n         Build only, not running QEMU
    -o <name>  Name of disk image [default: unix-<arch>.disk]
    -s <size>  Disk size in MiB [default: 64 MiB]
    -p <count> CPU count [default: 1]
    -R <size>  RAM size in MiB [default: 512 MiB]

Examples:
    $0 amd64
    $0 aarch64 -R 8192 -p 4 -rv
    $0 arm64 -n -V -o rawdisk.img
    $0 x86-64 -s 524288 -c

EOF
    exit 0
}

to_lower() {
    echo "$1" | tr '[:upper:]' '[:lower:]'
}

is_uint() {
    case "$1" in
        ''|*[!0-9]*) return 1 ;;
        *) return 0 ;;
    esac
}

die() {
    echo "Error: $1"
    echo "Use '$0 -h' for usage information"
    exit 1
}

if [ $# -eq 0 ]; then
    die "Architecture not specified"
fi

ARCH=`to_lower "$1"`
case $ARCH in
    -h)
        usage
        ;;
    aarch64|arm64|armv8|armv8a|armv8-a)
        DISK_ARCH="aarch64"
        ;;
    amd64|x86-64|x86_64|x64)
        DISK_ARCH="amd64"
        ;;
    *)
        die "Unknown architecture: $ARCH"
        ;;
esac
shift

DISK_NAME="unix-$DISK_ARCH.disk"

while [ $# -gt 0 ]; do
    case "$1" in
        -o)
            if [ -z "$2" ] || [ `echo "$2" | cut -c1` = "-" ]; then
                die_msg="-o requires a path argument"
                [ -n "$2" ] && die_msg="$die_msg\nIf you want to use a path with a leading dash, please consider adding \`./\` prefix."
                die "$die_msg"
            fi
            DISK_NAME="$2"
            shift
            ;;
        -p|-R|-s)
            if [ -z "$2" ] || ! is_uint "$2"; then
                die "$1 requires an uint argument"
            fi
            case "$1" in
                -p) CPU_COUNT="$2" ;;
                -R) RAM_SIZE="$2" ;;
                -s) DISK_SIZE="$2" ;;
            esac
            shift
            ;;
        -*)
            case "$1" in -*r*) RELEASE=true    ;; esac
            case "$1" in -*n*) BUILD_ONLY=true ;; esac
            case "$1" in -*c*) CLEAN=true      ;; esac
            case "$1" in -*v*) VERBOSE=1       ;; esac
            case "$1" in -*V*) VERBOSE=2       ;; esac
            ;;
    esac
    shift
done

SCRIPT_DIR=`dirname "$0"`

BUILD_ARGS="$ARCH"
if [ "$CLEAN" = "true" ]; then
    BUILD_ARGS="$BUILD_ARGS -c"
fi
if [ "$RELEASE" = "true" ]; then
    BUILD_ARGS="$BUILD_ARGS -r"
fi
case "$VERBOSE" in
    1) BUILD_ARGS="$BUILD_ARGS -v" ;;
    2) BUILD_ARGS="$BUILD_ARGS -V" ;;
esac

"$SCRIPT_DIR/build" $BUILD_ARGS
"$SCRIPT_DIR/img" -o $DISK_NAME -s $DISK_SIZE

if [ "$BUILD_ONLY" = "false" ]; then
    "$SCRIPT_DIR/run" $ARCH -i $DISK_NAME -r $RAM_SIZE -p $CPU_COUNT
fi
