#!/bin/sh

set -e
PRJCT_ROOT=`cd \`dirname "$0"\`/.. && pwd`

ARCH=""
VERBOSE=false
CLEAN=false
RELEASE=false

usage() {
    cat << EOF
UNIX V11 Build System

Usage: $0 <arch|-h> [options]

Architectures:
    AMD64   (alias: x86-64, x64)
    AArch64 (alias: Arm64, Armv8, Armv8a, Armv8-A)
    -h      Show this help

Options:
    -r      Release build
    -c      Clean before building
    -v      Verbose output

Examples:
    $0 amd64 -r -v
    $0 aarch64 -cv

EOF
    exit 0
}

to_lower() {
    echo "$1" | tr '[:upper:]' '[:lower:]'
}

die() {
    echo "Error: $1"
    echo "Use '$0 -h' for usage information"
    exit 1
}

if [ $# -eq 0 ]; then
    die "Architecture not specified"
fi

ARCH=`to_lower "$1"`
case $ARCH in
    -h)
        usage
        ;;
    aarch64|arm64|armv8|armv8a|armv8-a)
        EFI_TARGET="aarch64-unknown-uefi"
        KERNEL_TARGET="aarch64-unknown-none"
        EFI_BOOT_NAME="bootaa64.efi"
        ;;
    amd64|x86-64|x86_64|x64)
        EFI_TARGET="x86_64-unknown-uefi"
        KERNEL_TARGET="x86_64-unknown-none"
        EFI_BOOT_NAME="bootx64.efi"
        ;;
    *)
        die "Unknown architecture: $ARCH"
        ;;
esac

shift

while [ $# -gt 0 ]; do
    case "$1" in
        -*r*) RELEASE=true ;;
    esac
    case "$1" in
        -*c*) CLEAN=true ;;
    esac
    case "$1" in
        -*v*) VERBOSE=true ;;
    esac
    shift
done

if [ "$CLEAN" = "true" ]; then
    if [ "$VERBOSE" = "true" ]; then
        cargo clean
    else
        cargo clean -q
    fi
fi

BUILD_ARGS=""

if [ "$RELEASE" = "true" ]; then
    BUILD_ARGS="-r"
fi
if [ "$VERBOSE" = "false" ]; then
    BUILD_ARGS="$BUILD_ARGS -q"
fi

cd $PRJCT_ROOT/efi
cargo build --target $EFI_TARGET $BUILD_ARGS

cd $PRJCT_ROOT/kernel
cargo build --target $KERNEL_TARGET $BUILD_ARGS

cd $PRJCT_ROOT/corecli/aleph
cargo build --target $KERNEL_TARGET $BUILD_ARGS

cd $PRJCT_ROOT

rm -rf $PRJCT_ROOT/udisk
mkdir -p $PRJCT_ROOT/udisk
mkdir -p $PRJCT_ROOT/udisk/efi/boot
mkdir -p $PRJCT_ROOT/udisk/sbin

EFI_TARGET_DIR=`echo "$EFI_TARGET" | sed 's/\.json$//' | sed 's/.*\///'`
KERNEL_TARGET_DIR=`echo "$KERNEL_TARGET" | sed 's/\.json$//' | sed 's/.*\///'`

BUILD_DIR=""
if [ "$RELEASE" = "true" ]; then
    BUILD_DIR="release"
else
    BUILD_DIR="debug"
fi

cp $PRJCT_ROOT/target/$EFI_TARGET_DIR/$BUILD_DIR/unix-v11-efi.efi udisk/efi/boot/$EFI_BOOT_NAME
cp $PRJCT_ROOT/target/$KERNEL_TARGET_DIR/$BUILD_DIR/unix-v11-kernel udisk/unix
cp $PRJCT_ROOT/target/$KERNEL_TARGET_DIR/$BUILD_DIR/unix-v11-aleph udisk/sbin/aleph
echo System ready: udisk
