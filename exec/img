#!/bin/sh

set -e
PRJCT_ROOT=`cd \`dirname "$0"\`/.. && pwd`

DISK_NAME=unix.disk
DISK_SIZE=64

usage() {
    cat << EOF
UNIX V11 Imaging System

Usage: $0 [options]

Options:
    -o <name> Name of disk image [default: unix.disk]
    -s <size> Disk size in MiB [default: 64 MiB]
    -h        Show this help

Examples:
    $0
    $0 -s 512
    $0 -o hanabi.img
    $0 -s 524288 -o dmr\&klt.disk

EOF
    exit 0
}

to_lower() {
    echo "$1" | tr '[:upper:]' '[:lower:]'
}

is_uint() {
    case "$1" in
        ''|*[!0-9]*) return 1 ;;
        *) return 0 ;;
    esac
}

die() {
    echo "Error: $1"
    echo "Use '$0 -h' for usage information"
    exit 1
}

while [ $# -gt 0 ]; do
    case "$1" in
        -o)
            if [ -z "$2" ] || [ `echo "$2" | cut -c1` = "-" ]; then
                die_msg="-o requires a path argument"
                [ -n "$2" ] && die_msg="$die_msg\nIf you want to use a path with a leading dash, please consider adding \`./\` prefix."
                die "$die_msg"
            fi
            DISK_NAME="$2"
            shift
            ;;
        -s)
            if [ -z "$2" ] || ! is_uint "$2"; then
                die "-s requires an uint argument"
            fi
            DISK_SIZE="$2"
            shift
            ;;
        -h)
            usage
            ;;
    esac
    shift
done

dd if=/dev/zero of=$DISK_NAME bs=1M count=$DISK_SIZE status=none 2>/dev/null || \
dd if=/dev/zero of=$DISK_NAME bs=1m count=$DISK_SIZE status=none

if [ "`uname`" = "Darwin" ]; then
    diskno=`hdiutil attach -imagekey diskimage-class=CRawDiskImage -nomount $DISK_NAME | head -n 1 | awk '{print $1}'`
    diskutil eraseDisk FAT32 UNIXV11EFI GPTFormat $diskno > /dev/null
    cp -R $PRJCT_ROOT/udisk/* /Volumes/UNIXV11EFI/
    hdiutil detach $diskno > /dev/null
else
    LOOP_DEV=`sudo losetup -f --show $DISK_NAME`
    sudo parted -s $LOOP_DEV mklabel gpt
    sudo parted -s $LOOP_DEV mkpart primary fat32 1MiB 100%
    sudo mkfs.vfat -n UNIXV11EFI ${LOOP_DEV}p1 > /dev/null

    MOUNT_DIR=`mktemp -d`
    sudo mount ${LOOP_DEV}p1 $MOUNT_DIR
    sudo cp -R $PRJCT_ROOT/udisk/* $MOUNT_DIR/
    sudo umount $MOUNT_DIR
    rmdir $MOUNT_DIR
    sudo losetup -d $LOOP_DEV
fi

echo "Disk ready: $DISK_NAME"
